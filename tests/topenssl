#!/bin/bash
# Copyright (C) IBM Corp. 2022
# SPDX-License-Identifier: Apache-2.0

test -z "${TESTSDIR}" && exit 77
source "${TESTSDIR}/helpers.sh"

echo "##################################################"
echo "## Tests with openssl commands"
echo "##"
echo "## version:"
echo "## $(openssl version)"
echo "##"

echo "##################################################"
echo "## EC: sign/verify (pkcs11/file)"
echo "##"

ossl '
dgst -sign "${URI_KEY_ECDSA_PRV}"
     -sha256
     -out "${TMPPDIR}/random-1k.bin.ec-sig"
     "${TMPPDIR}/random-1k.bin"' \
|| exit 99

ossl '
dgst -verify "${FILE_PEM_ECDSA_PUB}"
     -sha256
     -signature "${TMPPDIR}/random-1k.bin.ec-sig"
     "${TMPPDIR}/random-1k.bin"' \
|| exit 99

echo "##################################################"
echo "## RSA: encrypt/decrypt (file/pkcs11)"
echo "##"

echo "## encrypt data"
ossl '
pkeyutl -encrypt -pkeyopt rsa_padding_mode:none
        -pubin -inkey "${FILE_PEM_RSA4K_PUB}"
        -in  "${TMPPDIR}/random-512.bin"
        -out "${TMPPDIR}/data.enc"' \
|| exit 99

echo "## decrypt data"
ossl '
pkeyutl -decrypt -pkeyopt rsa_padding_mode:none
        -inkey "${URI_KEY_RSA4K_PRV}"
        -in  "${TMPPDIR}/data.enc"
        -out "${TMPPDIR}/data.dec"' \
|| exit 99

echo "## decrypt results"
diff -q "${TMPPDIR}/random-512.bin" "${TMPPDIR}/data.dec" \
|| exit 99
echo "diff: identical results"
rm -f "${TMPPDIR}/data.enc" "${TMPPDIR}/data.dec"

exit 0
